<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Making static flow maps • spanishoddata</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><script src="flowmaps-static_files/libs/quarto-html/popper.min.js"></script><script src="flowmaps-static_files/libs/quarto-html/tippy.umd.min.js"></script><link href="flowmaps-static_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="flowmaps-static_files/libs/quarto-html/light-border.css" rel="stylesheet">
<!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Making static flow maps">
<meta property="og:image" content="https://rOpenSpain.github.io/spanishoddata/reference/figures/card.png">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:creator" content="@rOpenSpain">
<meta name="twitter:site" content="@rOpenSpain">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&amp;family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&amp;display=swap" rel="stylesheet">
<!-- rogtemplate style sheet --><link href="../BS5/rostemplate.min.css" rel="stylesheet">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
  <a class="navbar-brand me-2" href="../index.html">
    <img src="../apple-touch-icon-180x180.png" alt="spanishoddata logo" height="40" class="d-inline-block me-1">spanishoddata</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0.9000</small>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/v1-2020-2021-mitma-data-codebook.html">Codebook and cookbook for v1 (2020-2021) Spanish mobility data</a></li>
    <li><a class="dropdown-item" href="../articles/v2-2022-onwards-mitma-data-codebook.html">Codebook and cookbook for v2 (2022 onwards) Spanish mobility data</a></li>
    <li><a class="dropdown-item" href="../articles/quick-get.html">Quicky get daily data</a></li>
    <li><a class="dropdown-item" href="../articles/convert.html">Download and convert mobility datasets</a></li>
    <li><a class="dropdown-item" href="../articles/disaggregation.html">OD data disaggregation</a></li>
    <li><a class="dropdown-item" href="../articles/flowmaps-static.html">Making static flow maps</a></li>
    <li><a class="dropdown-item" href="../articles/flowmaps-interactive.html">Making interactive flow maps</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/rOpenSpain/spanishoddata/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>
  </div>
</nav><div class="container template-quarto">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Making static flow maps</h1>
      <p class="subtitle"><em>or how to re-create <a href="https://rOpenSpain.github.io/spanishoddata/">spanishoddata</a> logo</em></p>



      <small class="dont-index">Source: <a href="https://github.com/rOpenSpain/spanishoddata/blob/main/vignettes/flowmaps-static.qmd" class="external-link"><code>vignettes/flowmaps-static.qmd</code></a></small>
      <div class="d-none name"><code></code></div>
    </div>






    <p>This tutorial shows how to make static ‘flow maps’ with data from <a href="https://rOpenSpain.github.io/spanishoddata/">spanishoddata</a> and the <a href="https://github.com/JohMast/flowmapper" class="external-link">flowmapper</a> <span class="citation" data-cites="flowmapper-r">(<a href="#ref-flowmapper-r" role="doc-biblioref">Mast 2024</a>)</span> data visualisation package. We cover two examples. <a href="#simple-example">First</a>, we only use the origin-destination flows and district zones that you can get using the <a href="https://rOpenSpain.github.io/spanishoddata/">spanishoddata</a> package. In the <a href="#advanced-example">second</a> more advanced example we also use <a href="https://ropenspain.github.io/mapSpain/" class="external-link">mapSpain</a> and <a href="https://github.com/GuangchuangYu/hexSticker" class="external-link">hexSticker</a> packages to re-create the <a href="https://rOpenSpain.github.io/spanishoddata/">spanishoddata</a> logo. For both examples, make sure you first go though the initial <a href="#setup">setup steps</a>. To make interactive flow maps, please see the <a href="https://ropenspain.github.io/spanishoddata/articles/flowmaps-interactive.html" class="external-link">interactive flow maps</a> tutorial.</p>
<section class="section level2" data-number="1"><h2 data-number="1" id="setup">
<span class="header-section-number">1</span> Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rOpenSpain.github.io/spanishoddata/">spanishoddata</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/JohMast/flowmapper" class="external-link">flowmapper</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span></code></pre></div>
</div>
<section class="level2" data-number="1.1"><h3 data-number="1.1" id="set-data-folder">
<span class="header-section-number">1.1</span> Set the data directory<a class="anchor" aria-label="anchor" href="#set-data-folder"></a>
</h3>
<p>Choose where <a href="https://rOpenSpain.github.io/spanishoddata/">spanishoddata</a> should download (and convert) the data by setting the data directory following command:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/spod_set_data_dir.html">spod_set_data_dir</a></span><span class="op">(</span>data_dir <span class="op">=</span> <span class="st">"~/spanish_od_data"</span><span class="op">)</span></span></code></pre></div>
</div>
<p>The function above will also ensure that the directory is created and that you have sufficient permissions to write to it.</p>
<details><summary>
Setting data directory for advanced users
</summary><p>You can also set the data directory with an environment variable:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Sys.setenv.html" class="external-link">Sys.setenv</a></span><span class="op">(</span>SPANISH_OD_DATA_DIR <span class="op">=</span> <span class="st">"~/spanish_od_data"</span><span class="op">)</span></span></code></pre></div>
</div>
<p>The package will create this directory if it does not exist on the first run of any function that downloads the data.</p>
<p>To permanently set the directory for all projects, you can specify the data directory globally by setting the <code>SPANISH_OD_DATA_DIR</code> environment variable, e.g. with the following command:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">usethis</span><span class="fu">::</span><span class="fu"><a href="https://usethis.r-lib.org/reference/edit.html" class="external-link">edit_r_environ</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># Then set the data directory globally, by typing this line in the file:</span></span></code></pre></div>
</div>
<pre><code><span><span class="va">SPANISH_OD_DATA_DIR</span> <span class="op">=</span> <span class="st">"~/spanish_od_data"</span></span></code></pre>
<p>You can also set the data directory locally, just for the current project. Set the ‘envar’ in the working directory by editing <code>.Renviron</code> file in the root of the project:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/file.edit.html" class="external-link">file.edit</a></span><span class="op">(</span><span class="st">".Renviron"</span><span class="op">)</span></span></code></pre></div>
</div>
</details></section></section><section class="section level2" data-number="2"><h2 data-number="2" id="simple-example">
<span class="header-section-number">2</span> Simple example - plot flows data as it is<a class="anchor" aria-label="anchor" href="#simple-example"></a>
</h2>
<section class="level2" data-number="2.1"><h3 data-number="2.1" id="get-data">
<span class="header-section-number">2.1</span> Get data<a class="anchor" aria-label="anchor" href="#get-data"></a>
</h3>
<section class="level3" data-number="2.1.1"><h4 data-number="2.1.1" id="flows">
<span class="header-section-number">2.1.1</span> Flows<a class="anchor" aria-label="anchor" href="#flows"></a>
</h4>
<p>Let us get the flows between <code>districts</code> for a typical working day <code>2021-04-07</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">od_20210407</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spod_get.html">spod_get</a></span><span class="op">(</span><span class="st">"od"</span>, zones <span class="op">=</span> <span class="st">"distr"</span>, dates <span class="op">=</span> <span class="st">"2021-04-07"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">od_20210407</span><span class="op">)</span></span></code></pre></div>
</div>
<pre><code># Source:   SQL [6 x 14]
# Database: DuckDB v1.0.0 [root@Darwin 23.6.0:R 4.4.1/:memory:]
  date       id_origin id_destination activity_origin activity_destination residence_province_in…¹ residence_province_n…² time_slot distance n_trips trips_total_length_km  year month
  &lt;date&gt;     &lt;fct&gt;     &lt;fct&gt;          &lt;fct&gt;           &lt;fct&gt;                &lt;fct&gt;                   &lt;fct&gt;                      &lt;int&gt; &lt;fct&gt;      &lt;dbl&gt;                 &lt;dbl&gt; &lt;int&gt; &lt;int&gt;
1 2021-04-07 01001_AM  01001_AM       home            other                01                      Araba/Álava                    0 005-010     10.5                  68.9  2021     4
2 2021-04-07 01001_AM  01001_AM       home            other                01                      Araba/Álava                    0 010-050     12.6                 127.   2021     4
3 2021-04-07 01001_AM  01001_AM       home            other                01                      Araba/Álava                    1 010-050     12.6                 232.   2021     4
4 2021-04-07 01001_AM  01001_AM       home            other                01                      Araba/Álava                    2 005-010     10.8                 102.   2021     4
5 2021-04-07 01001_AM  01001_AM       home            other                01                      Araba/Álava                    5 005-010     18.9                 156.   2021     4
6 2021-04-07 01001_AM  01001_AM       home            other                01                      Araba/Álava                    6 010-050     10.8                 119.   2021     4
# ℹ abbreviated names: ¹​residence_province_ine_code, ²​residence_province_name
# ℹ 1 more variable: day &lt;int&gt;</code></pre>
</section><section class="level3" data-number="2.1.2"><h4 data-number="2.1.2" id="zones">
<span class="header-section-number">2.1.2</span> Zones<a class="anchor" aria-label="anchor" href="#zones"></a>
</h4>
<p>We also get the district zones polygons to match the flows. We use version 1 for the polygons, because the selected date is in 2021, which corresponds to the v1 data (see the relevant <a href="v1-2020-2021-mitma-data-codebook.html">codebook</a>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">districts_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spod_get_zones.html">spod_get_zones</a></span><span class="op">(</span><span class="st">"dist"</span>, ver <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">districts_v1</span><span class="op">)</span></span></code></pre></div>
</div>
<pre><code>Simple feature collection with 6 features and 6 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: 289502.8 ymin: 4173922 xmax: 1010926 ymax: 4720817
Projected CRS: ETRS89 / UTM zone 30N (N-E)
# A tibble: 6 × 7
  id       census_districts                                              municipalities_mitma municipalities         district_names_in_v2 district_ids_in_v2                      geom
  &lt;chr&gt;    &lt;chr&gt;                                                         &lt;chr&gt;                &lt;chr&gt;                  &lt;chr&gt;                &lt;chr&gt;                     &lt;MULTIPOLYGON [m]&gt;
1 2408910  2408910                                                       24089                24089                  León distrito 10     2408910            (((290940.1 4719080, 290…
2 22117_AM 2210201; 2210301; 2211501; 2211701; 2216401; 2218701; 2221401 22117_AM             22102; 22103; 22115; … Graus agregacion de… 22117_AM           (((774184.4 4662153, 774…
3 2305009  2305009                                                       23050                23050                  Jaén distrito 09     2305009            (((429745 4179977, 42971…
4 07058_AM 0701901; 0702501; 0703401; 0705801; 0705802                   07058_AM             07019; 07025; 07034; … Selva agregacion de… 07058_AM           (((1000859 4415059, 1000…
5 2305006  2305006                                                       23050                23050                  Jaén distrito 06     2305006            (((429795.1 4180957, 429…
6 2305005  2305005                                                       23050                23050                  Jaén distrito 05     2305005            (((430022.7 4181101, 429…</code></pre>
</section></section><section class="level2" data-number="2.2"><h3 data-number="2.2" id="aggregate-data---count-total-flows">
<span class="header-section-number">2.2</span> Aggregate data - count total flows<a class="anchor" aria-label="anchor" href="#aggregate-data---count-total-flows"></a>
</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">od_20210407_total</span> <span class="op">&lt;-</span> <span class="va">od_20210407</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span>o <span class="op">=</span> <span class="va">id_origin</span>, d <span class="op">=</span> <span class="va">id_destination</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">n_trips</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">o</span>, <span class="va">d</span>, <span class="va">value</span><span class="op">)</span></span></code></pre></div>
</div>
</section><section class="level2" data-number="2.3"><h3 data-number="2.3" id="reshape-flows-for-visualization">
<span class="header-section-number">2.3</span> Reshape flows for visualization<a class="anchor" aria-label="anchor" href="#reshape-flows-for-visualization"></a>
</h3>
<p>The <a href="https://github.com/JohMast/flowmapper" class="external-link">flowmapper</a> package was developed to visualise origin-destination ‘flow’ data <span class="citation" data-cites="flowmapper-r">(<a href="#ref-flowmapper-r" role="doc-biblioref">Mast 2024</a>)</span>. This package expects the data to be in the following format:</p>
<p>A <code>data.frame</code> with origin-destination pairs and the flow counts between them with the following columns:</p>
<ul>
<li><p><code>o</code>: The unique id of the origin node</p></li>
<li><p><code>d</code>: The unique id of the destination node</p></li>
<li><p><code>value</code>: The intensity of flow between the origin and destination</p></li>
</ul>
<p>Another <code>data.frame</code> with the node <code>id</code>s or names and their coorindates. The coordinate reference system should match whichever other data you are planning to use in the plot.</p>
<p><code>name</code>: The unique <code>id</code> or <code>name</code> of the node, must match with <code>o</code> and <code>d</code> in the flows <code>data.frame</code> above;</p>
<p><code>x</code>: The x coordinate of the node;</p>
<p><code>y</code>: The y coordinate of the node;</p>
<section class="level3" data-number="2.3.1"><h4 data-number="2.3.1" id="prepare-the-flows-table">
<span class="header-section-number">2.3.1</span> Prepare the flows table<a class="anchor" aria-label="anchor" href="#prepare-the-flows-table"></a>
</h4>
<p>The previous code chunk created <code>od_20210407_total</code> with the column names expected by <a href="https://github.com/JohMast/flowmapper" class="external-link">flowmapper</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">od_20210407_total</span><span class="op">)</span></span></code></pre></div>
</div>
<pre><code># A tibble: 6 × 3
  o       d          value
  &lt;fct&gt;   &lt;fct&gt;      &lt;dbl&gt;
1 2408910 2408910  1889.
2 2408910 24154_AM   11.0
3 2408910 5029703    12.8
4 2408910 24181_AM   22.3
5 2408910 4802004     9.45
6 2408910 4718608     4.75 </code></pre>
</section><section class="level3" data-number="2.3.2"><h4 data-number="2.3.2" id="prepare-the-nodes-table-with-coordinates">
<span class="header-section-number">2.3.2</span> Prepare the nodes table with coordinates<a class="anchor" aria-label="anchor" href="#prepare-the-nodes-table-with-coordinates"></a>
</h4>
<p>We need the coordinates for each origin and destination. We can use the centroids of <code>districts_v1</code> polygons for that.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">districts_v1_coords</span> <span class="op">&lt;-</span> <span class="va">districts_v1</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_centroid</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html" class="external-link">st_coordinates</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>name <span class="op">=</span> <span class="va">districts_v1</span><span class="op">$</span><span class="va">id</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">X</span>, y <span class="op">=</span> <span class="va">Y</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">districts_v1_coords</span><span class="op">)</span></span></code></pre></div>
</div>
<pre><code>          x       y     name
1  290380.7 4719394  2408910
2  774727.2 4674304 22117_AM
3  428315.4 4177662  2305009
4 1001283.0 4422732 07058_AM
5  427524.2 4180942  2305006
6  428302.1 4190937  2305005</code></pre>
</section></section><section class="level2" data-number="2.4"><h3 data-number="2.4" id="plot-the-flows">
<span class="header-section-number">2.4</span> Plot the flows<a class="anchor" aria-label="anchor" href="#plot-the-flows"></a>
</h3>
<section class="level3" data-number="2.4.1"><h4 data-number="2.4.1" id="plot-the-entire-country">
<span class="header-section-number">2.4.1</span> Plot the entire country<a class="anchor" aria-label="anchor" href="#plot-the-entire-country"></a>
</h4>
<p>Now we have the data structure that match the <a href="https://github.com/JohMast/flowmapper" class="external-link">flowmapper</a>‘s expected data format we can plot a sample of the data (a plot containing all flows would be very ’busy’ and world resemble a haystack!). The <code>k_node</code> argument in the <code>add_flowmap</code> function can be used to reduce this business.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># create base ggplot with boundaries removing various visual clutter</span></span>
<span><span class="va">base_plot_districts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">districts_v1</span>, fill<span class="op">=</span><span class="cn">NA</span>, col <span class="op">=</span> <span class="st">"grey60"</span>, linewidth <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">20</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">""</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">""</span>, fill <span class="op">=</span> <span class="st">""</span>, caption <span class="op">=</span> <span class="st">""</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    axis.line <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    axis.ticks <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_rect</a></span><span class="op">(</span>fill<span class="op">=</span><span class="st">'transparent'</span><span class="op">)</span>,</span>
<span>    plot.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_rect</a></span><span class="op">(</span>fill<span class="op">=</span><span class="st">'transparent'</span>, color<span class="op">=</span><span class="cn">NA</span><span class="op">)</span>,</span>
<span>    panel.grid.major <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># flows_by_ca_twoway_coords |&gt; arrange(desc(flow_ab))</span></span>
<span><span class="co"># add the flows</span></span>
<span><span class="va">flows_plot_all_districts</span> <span class="op">&lt;-</span> <span class="va">base_plot_districts</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/flowmapper/man/add_flowmap.html" class="external-link">add_flowmap</a></span><span class="op">(</span></span>
<span>    od <span class="op">=</span> <span class="va">od_20210407_total</span>,</span>
<span>    nodes <span class="op">=</span> <span class="va">districts_v1_coords</span>,</span>
<span>    node_radius_factor <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    edge_width_factor <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    arrow_point_angle <span class="op">=</span> <span class="fl">35</span>,</span>
<span>    node_buffer_factor <span class="op">=</span> <span class="fl">1.5</span>,</span>
<span>    outline_col <span class="op">=</span> <span class="st">"grey80"</span>,</span>
<span>    add_legend <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>    legend_col <span class="op">=</span> <span class="st">"gray20"</span>,</span>
<span>    legend_gradient <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    k_node <span class="op">=</span> <span class="fl">20</span> <span class="co"># play around with this parameter to aggregate nodes and flows</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># customise colours for the fill</span></span>
<span><span class="va">flows_plot_all_districts</span> <span class="op">&lt;-</span> <span class="va">flows_plot_all_districts</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html" class="external-link">scale_fill_gradient</a></span><span class="op">(</span></span>
<span>    low <span class="op">=</span> <span class="st">"#FABB29"</span>, </span>
<span>    high <span class="op">=</span> <span class="st">"#AB061F"</span>, </span>
<span>    labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/comma.html" class="external-link">comma_format</a></span><span class="op">(</span><span class="op">)</span>  <span class="co"># Real value labels</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">flows_plot_all_districts</span></span></code></pre></div>
</div>
<p><img src="../reference/figures/flows_plot_all_districts.png"></p>
</section><section class="level3" data-number="2.4.2"><h4 data-number="2.4.2" id="zoom-in-to-the-city-level">
<span class="header-section-number">2.4.2</span> Zoom in to the city level<a class="anchor" aria-label="anchor" href="#zoom-in-to-the-city-level"></a>
</h4>
<p>Let us filter the flows and zones data to just a specific functional urban area to take a closer look at the flows.</p>
<section class="level4" data-number="2.4.2.1"><h5 data-number="2.4.2.1" id="filter-the-zones">
<span class="header-section-number">2.4.2.1</span> Filter the zones<a class="anchor" aria-label="anchor" href="#filter-the-zones"></a>
</h5>
<p>Let us select all districts that correspond to Barcelona and a 10 km radius around it. Thanks to the <code>district_names_in_v2</code> column in the zones data, we can easily select all the districts that correspond to Barcelona and then apply the spatial join on the to select some more districts around the polygons that correspond to Barcelona.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">zones_barcelona</span> <span class="op">&lt;-</span> <span class="va">districts_v1</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"Barcelona"</span>, <span class="va">district_names_in_v2</span>, ignore.case <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">zones_barcelona_fua</span> <span class="op">&lt;-</span> <span class="va">districts_v1</span><span class="op">[</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_buffer</a></span><span class="op">(</span><span class="va">zones_barcelona</span>, dist <span class="op">=</span> <span class="fl">10000</span><span class="op">)</span></span>
<span>  ,</span>
<span><span class="op">]</span></span>
<span></span>
<span><span class="va">zones_barcelona_fua_plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">zones_barcelona_fua</span>, fill<span class="op">=</span><span class="cn">NA</span>, col <span class="op">=</span> <span class="st">"grey60"</span>, linewidth <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">zones_barcelona_fua_plot</span></span></code></pre></div>
</div>
<p><img src="../reference/figures/zones_barcelona_fua_plot.png"></p>
<p>We also prepare the nodes for the <code>add_flowmap</code> function:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">zones_barcelona_fua_coords</span> <span class="op">&lt;-</span> <span class="va">zones_barcelona_fua</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_centroid</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html" class="external-link">st_coordinates</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>name <span class="op">=</span> <span class="va">zones_barcelona_fua</span><span class="op">$</span><span class="va">id</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">X</span>, y <span class="op">=</span> <span class="va">Y</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">zones_barcelona_fua_coords</span><span class="op">)</span></span></code></pre></div>
</div>
<pre><code>      x       y    name
1 930267.0 4607072   08180
2 914854.0 4604279   08054
3 926837.9 4597166 0801905
4 927995.1 4594372 0801904
5 930418.9 4599218 0801907
6 930702.3 4597116 0801906</code></pre>
</section><section class="level4" data-number="2.4.2.2"><h5 data-number="2.4.2.2" id="prepare-the-flows">
<span class="header-section-number">2.4.2.2</span> Prepare the flows<a class="anchor" aria-label="anchor" href="#prepare-the-flows"></a>
</h5>
<p>Now we can use the zone <code>id</code>s from the <code>zones_barcelona_fua</code> data to select the flows that correspond to Barcelona and the 10 km radius around it.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">od_20210407_total_barcelona</span> <span class="op">&lt;-</span> <span class="va">od_20210407_total</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">o</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">zones_barcelona_fua</span><span class="op">$</span><span class="va">id</span> <span class="op">&amp;</span> <span class="va">d</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">zones_barcelona_fua</span><span class="op">$</span><span class="va">id</span><span class="op">)</span></span></code></pre></div>
</div>
</section><section class="level4" data-number="2.4.2.3"><h5 data-number="2.4.2.3" id="visualise-the-flows-for-barcelona-and-surrounding-areas">
<span class="header-section-number">2.4.2.3</span> Visualise the flows for Barcelona and surrounding areas<a class="anchor" aria-label="anchor" href="#visualise-the-flows-for-barcelona-and-surrounding-areas"></a>
</h5>
<p>Now, we can create a new plot with this data. Once again, we need the <code>k_node</code> argument to tweak the aggregation of nodes and flows. Feel free to tweak it yourself and see how the results change.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># create base ggplot with boundaries removing various visual clutter</span></span>
<span><span class="va">base_plot_barcelona</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">zones_barcelona_fua</span>, fill<span class="op">=</span><span class="cn">NA</span>, col <span class="op">=</span> <span class="st">"grey60"</span>, linewidth <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">20</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">""</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">""</span>, fill <span class="op">=</span> <span class="st">""</span>, caption <span class="op">=</span> <span class="st">""</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    axis.line <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    axis.ticks <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_rect</a></span><span class="op">(</span>fill<span class="op">=</span><span class="st">'transparent'</span><span class="op">)</span>,</span>
<span>    plot.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_rect</a></span><span class="op">(</span>fill<span class="op">=</span><span class="st">'transparent'</span>, color<span class="op">=</span><span class="cn">NA</span><span class="op">)</span>,</span>
<span>    panel.grid.major <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">'none'</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># flows_by_ca_twoway_coords |&gt; arrange(desc(flow_ab))</span></span>
<span><span class="co"># add the flows</span></span>
<span><span class="va">flows_plot_barcelona</span> <span class="op">&lt;-</span> <span class="va">base_plot_barcelona</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/flowmapper/man/add_flowmap.html" class="external-link">add_flowmap</a></span><span class="op">(</span></span>
<span>    od <span class="op">=</span> <span class="va">od_20210407_total_barcelona</span>,</span>
<span>    nodes <span class="op">=</span> <span class="va">zones_barcelona_fua_coords</span>,</span>
<span>    node_radius_factor <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    edge_width_factor <span class="op">=</span> <span class="fl">0.6</span>,</span>
<span>    arrow_point_angle <span class="op">=</span> <span class="fl">45</span>,</span>
<span>    node_buffer_factor <span class="op">=</span> <span class="fl">1.5</span>,</span>
<span>    outline_col <span class="op">=</span> <span class="st">"grey80"</span>,</span>
<span>    add_legend <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>    legend_col <span class="op">=</span> <span class="st">"gray20"</span>,</span>
<span>    legend_gradient <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    k_node <span class="op">=</span> <span class="fl">30</span> <span class="co"># play around with this parameter to aggregate nodes and flows</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># customise colours for the fill</span></span>
<span><span class="va">flows_plot_barcelona</span> <span class="op">&lt;-</span> <span class="va">flows_plot_barcelona</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html" class="external-link">scale_fill_gradient</a></span><span class="op">(</span></span>
<span>    low <span class="op">=</span> <span class="st">"#FABB29"</span>, </span>
<span>    high <span class="op">=</span> <span class="st">"#AB061F"</span>, </span>
<span>    labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/comma.html" class="external-link">comma_format</a></span><span class="op">(</span><span class="op">)</span>  <span class="co"># Real value labels</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">flows_plot_barcelona</span></span></code></pre></div>
</div>
<p><img src="../reference/figures/flows_plot_barcelona.png"></p>
</section></section></section></section><section class="section level2" data-number="3"><h2 data-number="3" id="advanced-example">
<span class="header-section-number">3</span> Advanced example - aggregate flows for <code>{spanishoddata}</code> logo<a class="anchor" aria-label="anchor" href="#advanced-example"></a>
</h2>
<p>For the advanced example we will need two additional packages: <a href="https://ropenspain.github.io/mapSpain/" class="external-link">mapSpain</a> <span class="citation" data-cites="R-mapspain">(<a href="#ref-R-mapspain" role="doc-biblioref">Hernangómez 2024</a>)</span> and <a href="https://github.com/GuangchuangYu/hexSticker" class="external-link">hexSticker</a> <span class="citation" data-cites="R-hexSticker">(<a href="#ref-R-hexSticker" role="doc-biblioref"><strong>R-hexSticker?</strong></a>)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># two new packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ropenspain.github.io/mapSpain/" class="external-link">mapSpain</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/GuangchuangYu/hexSticker" class="external-link">hexSticker</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># load these too, if you have not already</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rOpenSpain.github.io/spanishoddata/">spanishoddata</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/JohMast/flowmapper" class="external-link">flowmapper</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span></code></pre></div>
</div>
<section class="level2" data-number="3.1"><h3 data-number="3.1" id="get-data-1">
<span class="header-section-number">3.1</span> Get data<a class="anchor" aria-label="anchor" href="#get-data-1"></a>
</h3>
<section class="level3" data-number="3.1.1"><h4 data-number="3.1.1" id="flows-1">
<span class="header-section-number">3.1.1</span> Flows<a class="anchor" aria-label="anchor" href="#flows-1"></a>
</h4>
<p>Just like in the simple example above, we will need the flows to visualise.</p>
<p>Let us get the origin-destination flows between <code>districts</code> for a typical working day <code>2022-04-06</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">od</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spod_get.html">spod_get</a></span><span class="op">(</span><span class="st">"od"</span>, zones <span class="op">=</span> <span class="st">"distr"</span>, dates <span class="op">=</span> <span class="st">"2022-04-06"</span><span class="op">)</span></span></code></pre></div>
</div>
<p>Also get the spatial data for the zones. We are using the version 2 of zones, because the data we got was for 2022 and onwards, which corresponds to the v2 data (see the relevant <a href="v2-2022-onwards-mitma-data-codebook.html">codebook</a>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">districts</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spod_get_zones.html">spod_get_zones</a></span><span class="op">(</span><span class="st">"distr"</span>, ver <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
</div>
</section><section class="level3" data-number="3.1.2"><h4 data-number="3.1.2" id="map-of-spain">
<span class="header-section-number">3.1.2</span> Map of Spain<a class="anchor" aria-label="anchor" href="#map-of-spain"></a>
</h4>
<p>Ultimately, we would like to plot the flows on a map of Spain, so we will aggregate the flows for visualisation to avoid visual clutter. We therefore also need a nice map of Spain, which we will get using <a href="https://ropenspain.github.io/mapSpain/" class="external-link">mapSpain</a> <span class="citation" data-cites="R-mapspain">(<a href="#ref-R-mapspain" role="doc-biblioref">Hernangómez 2024</a>)</span> package:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">spain_for_vis</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ropenspain.github.io/mapSpain/reference/esp_get_ccaa.html" class="external-link">esp_get_ccaa</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">spain_for_join</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ropenspain.github.io/mapSpain/reference/esp_get_ccaa.html" class="external-link">esp_get_ccaa</a></span><span class="op">(</span>moveCAN <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
</div>
<p>We are getting two sets of boundaries. First one is with Canary Islands moved closer to the mainland Spain, for nicer visualisation. Second one is with the original location of the islands, so that we can spatially join them to the zones <code>districts</code> data we got from <a href="https://rOpenSpain.github.io/spanishoddata/">spanishoddata</a>.</p>
</section></section><section class="level2" data-number="3.2"><h3 data-number="3.2" id="flows-aggregation">
<span class="header-section-number">3.2</span> Flows aggregation<a class="anchor" aria-label="anchor" href="#flows-aggregation"></a>
</h3>
<section class="level3" data-number="3.2.1"><h4 data-number="3.2.1" id="aggregate-raw-origin-destination-data-by-original-ids">
<span class="header-section-number">3.2.1</span> Aggregate raw origin destination data by original <code>id</code>s<a class="anchor" aria-label="anchor" href="#aggregate-raw-origin-destination-data-by-original-ids"></a>
</h4>
<p>Let us count the total number of trips made between all locations on our selected day of <code>2022-04-06</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">flows_by_district</span> <span class="op">&lt;-</span> <span class="va">od</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">id_origin</span>, <span class="va">id_destination</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>n_trips <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">n_trips</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html" class="external-link">desc</a></span><span class="op">(</span><span class="va">id_origin</span><span class="op">)</span>, <span class="va">id_destination</span>, <span class="va">n_trips</span><span class="op">)</span></span>
<span></span>
<span><span class="va">flows_by_district</span></span></code></pre></div>
</div>
<pre><code># A tibble: 402,711 × 3
   id_origin id_destination n_trips
   &lt;fct&gt;     &lt;fct&gt;            &lt;dbl&gt;
 1 31260_AM  01017_AM          7.15
 2 31260_AM  01043            13.7
 3 31260_AM  0105902          16.1
 4 31260_AM  2512005          12.2
 5 31260_AM  26002_AM          8
 6 31260_AM  26026_AM          4
 7 31260_AM  26036            38.3
 8 31260_AM  26061_AM         10.6
 9 31260_AM  26084             5.5
10 31260_AM  2608902         109.
# ℹ 402,701 more rows
# ℹ Use `print(n = ...)` to see more rows</code></pre>
</section><section class="level3" data-number="3.2.2"><h4 data-number="3.2.2" id="match-ids-of-districts-with-autonomous-communities">
<span class="header-section-number">3.2.2</span> Match <code>id</code>s of <code>districts</code> with autonomous communities<a class="anchor" aria-label="anchor" href="#match-ids-of-districts-with-autonomous-communities"></a>
</h4>
<p>Now we need to do a spatial join between <code>districts</code> and <code>spain_for_join</code> to find out which districts fall within which autonomous community. We use <code>spain_for_join</code>. If we used <code>spain_for_vis</code>, the <code>districts</code> in the Canary Islands would not match with the boundaries of the islands.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">district_centroids</span> <span class="op">&lt;-</span> <span class="va">districts</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_centroid</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span>crs <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_crs</a></span><span class="op">(</span><span class="va">spain_for_join</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ca_distr</span> <span class="op">&lt;-</span> <span class="va">district_centroids</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_join.html" class="external-link">st_join</a></span><span class="op">(</span><span class="va">spain_for_join</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_drop_geometry</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">ccaa.shortname.en</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">id</span>, ca_name <span class="op">=</span> <span class="va">ccaa.shortname.en</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ca_distr</span></span></code></pre></div>
</div>
<pre><code># A tibble: 3,784 × 2
   id       ca_name
   &lt;chr&gt;    &lt;chr&gt;
 1 01001    Basque Country
 2 01002    Basque Country
 3 01004_AM Basque Country
 4 01009_AM Basque Country
 5 01010    Basque Country
 6 01017_AM Basque Country
 7 01028_AM Basque Country
 8 01036    Basque Country
 9 01043    Basque Country
10 01047_AM Basque Country
# ℹ 3,774 more rows
# ℹ Use `print(n = ...)` to see more rows</code></pre>
<p>This way we get a table with <code>districts</code> <code>id</code>s and their corresponding autonomous community names.</p>
</section><section class="level3" data-number="3.2.3"><h4 data-number="3.2.3" id="count-flows-between-pairs-of-autonomous-communities">
<span class="header-section-number">3.2.3</span> Count flows between pairs of autonomous communities<a class="anchor" aria-label="anchor" href="#count-flows-between-pairs-of-autonomous-communities"></a>
</h4>
<p>We can now add these ids to the total flows by <code>districts</code> <code>id</code> pairs and calculate total flows between autonomous communities:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">flows_by_ca</span> <span class="op">&lt;-</span> <span class="va">flows_by_district</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">ca_distr</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>id_orig <span class="op">=</span> <span class="va">ca_name</span><span class="op">)</span>,</span>
<span>      by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"id_origin"</span> <span class="op">=</span> <span class="st">"id"</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">ca_distr</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>id_dest <span class="op">=</span> <span class="va">ca_name</span><span class="op">)</span>,</span>
<span>      by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"id_destination"</span> <span class="op">=</span> <span class="st">"id"</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">id_orig</span>, <span class="va">id_dest</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>n_trips <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">n_trips</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>o <span class="op">=</span> <span class="va">id_orig</span>, d <span class="op">=</span> <span class="va">id_dest</span>, value <span class="op">=</span> <span class="va">n_trips</span><span class="op">)</span></span>
<span></span>
<span><span class="va">flows_by_ca</span></span></code></pre></div>
</div>
<pre><code># A tibble: 358 × 3
   o         d                     value
   &lt;chr&gt;     &lt;chr&gt;                 &lt;dbl&gt;
 1 Andalusia Andalusia         23681858.
 2 Andalusia Aragon                 643.
 3 Andalusia Asturias               373.
 4 Andalusia Balearic Islands       931.
 5 Andalusia Basque Country         769.
 6 Andalusia Canary Islands        1899.
 7 Andalusia Cantabria              153.
 8 Andalusia Castile and León      3114.
 9 Andalusia Castile-La Mancha    13655.
10 Andalusia Catalonia             5453.
# ℹ 348 more rows
# ℹ Use `print(n = ...)` to see more rows</code></pre>
</section></section><section class="level2" data-number="3.3"><h3 data-number="3.3" id="reshape-flows-for-visualization-1">
<span class="header-section-number">3.3</span> Reshape flows for visualization<a class="anchor" aria-label="anchor" href="#reshape-flows-for-visualization-1"></a>
</h3>
<p>We are going to use the <a href="https://github.com/JohMast/flowmapper" class="external-link">flowmapper</a> <span class="citation" data-cites="flowmapper-r">(<a href="#ref-flowmapper-r" role="doc-biblioref">Mast 2024</a>)</span> package to plot the flows. This package expects the data to be in the following format:</p>
<p>A <code>data.frame</code> with origin-destination pairs and the flow counts between them with the following columns:</p>
<ul>
<li><p><code>o</code>: The unique id of the origin node</p></li>
<li><p><code>d</code>: The unique id of the destination node</p></li>
<li><p><code>value</code>: The intensity of flow between the origin and destination</p></li>
</ul>
<p>Another <code>data.frame</code> with the node <code>id</code>s or names and their coorindates. The coordinate reference system should match whichever other data you are planning to use in the plot.</p>
<p><code>name</code>: The unique <code>id</code> or <code>name</code> of the node, must match with <code>o</code> and <code>d</code> in the flows <code>data.frame</code> above;</p>
<p><code>x</code>: The x coordinate of the node;</p>
<p><code>y</code>: The y coordinate of the node;</p>
<section class="level3" data-number="3.3.1"><h4 data-number="3.3.1" id="prepare-the-flows-table-1">
<span class="header-section-number">3.3.1</span> Prepare the flows table<a class="anchor" aria-label="anchor" href="#prepare-the-flows-table-1"></a>
</h4>
<p>The data we have right now in <code>flows_by_ca</code> already has the correct format expected by <a href="https://github.com/JohMast/flowmapper" class="external-link">flowmapper</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">flows_by_ca</span><span class="op">)</span></span></code></pre></div>
</div>
<pre><code># A tibble: 6 × 3
  o         d                    value
  &lt;chr&gt;     &lt;chr&gt;                &lt;dbl&gt;
1 Andalusia Andalusia        23681858.
2 Andalusia Aragon                643.
3 Andalusia Asturias              373.
4 Andalusia Balearic Islands      931.
5 Andalusia Basque Country        769.
6 Andalusia Canary Islands       1899.</code></pre>
</section><section class="level3" data-number="3.3.2"><h4 data-number="3.3.2" id="prepare-the-nodes-table-with-coordinates-1">
<span class="header-section-number">3.3.2</span> Prepare the nodes table with coordinates<a class="anchor" aria-label="anchor" href="#prepare-the-nodes-table-with-coordinates-1"></a>
</h4>
<p>We need the coordinates for each origin and destination. We can use the centroids of <code>districts_v1</code> polygons for that.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">spain_for_vis_coords</span> <span class="op">&lt;-</span> <span class="va">spain_for_vis</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_centroid</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html" class="external-link">st_coordinates</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>name <span class="op">=</span> <span class="va">spain_for_vis</span><span class="op">$</span><span class="va">ccaa.shortname.en</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">X</span>, y <span class="op">=</span> <span class="va">Y</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">spain_for_vis_coords</span><span class="op">)</span></span></code></pre></div>
</div>
<pre><code>      x        y             name
1  -4.5777846 37.46782        Andalusia
2  -0.6648791 41.51335           Aragon
3  -5.9936312 43.29377         Asturias
4   2.9065933 39.57481 Balearic Islands
5 -10.7324736 35.36091   Canary Islands
6  -4.0300438 43.19772        Cantabria</code></pre>
</section></section><section class="level2" data-number="3.4"><h3 data-number="3.4" id="plot-the-flows-1">
<span class="header-section-number">3.4</span> Plot the flows<a class="anchor" aria-label="anchor" href="#plot-the-flows-1"></a>
</h3>
<p>Now we have the data structure that match the <a href="https://github.com/JohMast/flowmapper" class="external-link">flowmapper</a>’s expected data format:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># create base ggplot with boundaries removing any extra elements</span></span>
<span><span class="va">base_plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">spain_for_vis</span>, fill<span class="op">=</span><span class="cn">NA</span>, col <span class="op">=</span> <span class="st">"grey30"</span>, linewidth <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">20</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">""</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">""</span>, fill <span class="op">=</span> <span class="st">""</span>, caption <span class="op">=</span> <span class="st">""</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    axis.line <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    axis.ticks <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_rect</a></span><span class="op">(</span>fill<span class="op">=</span><span class="st">'transparent'</span><span class="op">)</span>,</span>
<span>    plot.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_rect</a></span><span class="op">(</span>fill<span class="op">=</span><span class="st">'transparent'</span>, color<span class="op">=</span><span class="cn">NA</span><span class="op">)</span>,</span>
<span>    panel.grid.major <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">'none'</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># flows_by_ca_twoway_coords |&gt; arrange(desc(flow_ab))</span></span>
<span><span class="co"># add the flows</span></span>
<span><span class="va">flows_plot</span> <span class="op">&lt;-</span> <span class="va">base_plot</span><span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/flowmapper/man/add_flowmap.html" class="external-link">add_flowmap</a></span><span class="op">(</span></span>
<span>    od <span class="op">=</span> <span class="va">flows_by_ca</span>,</span>
<span>    nodes <span class="op">=</span> <span class="va">spain_for_vis_coords</span>,</span>
<span>    node_radius_factor <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    edge_width_factor <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    arrow_point_angle <span class="op">=</span> <span class="fl">35</span>,</span>
<span>    node_buffer_factor <span class="op">=</span> <span class="fl">1.5</span>,</span>
<span>    outline_col <span class="op">=</span> <span class="st">"grey80"</span>,</span>
<span>    k_node <span class="op">=</span> <span class="fl">10</span> <span class="co"># play around with this parameter to aggregate nodes and flows</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># customise colours and remove legend, as we need a clean image for the logo</span></span>
<span><span class="va">flows_plot</span> <span class="op">&lt;-</span> <span class="va">flows_plot</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>fill<span class="op">=</span><span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html" class="external-link">scale_fill_gradient</a></span><span class="op">(</span>low<span class="op">=</span><span class="st">"#FABB29"</span>, high <span class="op">=</span> <span class="st">"#AB061F"</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">flows_plot</span></span></code></pre></div>
</div>
<p><img src="../reference/figures/logo-before-hex.png"></p>
<p>The image may look a bit bleak, but when we put it on a sticker, it will look great.</p>
</section><section class="level2" data-number="3.5"><h3 data-number="3.5" id="make-the-sticker">
<span class="header-section-number">3.5</span> Make the sticker<a class="anchor" aria-label="anchor" href="#make-the-sticker"></a>
</h3>
<p>We make the sticker using the <a href="https://github.com/GuangchuangYu/hexSticker" class="external-link">hexSticker</a> <span class="citation" data-cites="hexSticker-r">(<a href="#ref-hexSticker-r" role="doc-biblioref">Yu 2020</a>)</span> package.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/hexSticker/man/sticker.html" class="external-link">sticker</a></span><span class="op">(</span><span class="va">flows_plot</span>,</span>
<span></span>
<span>  <span class="co"># package name</span></span>
<span>  package<span class="op">=</span> <span class="st">"spanishoddata"</span>, </span>
<span>  p_size<span class="op">=</span><span class="fl">4</span>, p_y <span class="op">=</span> <span class="fl">1.6</span>,</span>
<span>  p_color <span class="op">=</span> <span class="st">"gray25"</span>, p_family<span class="op">=</span><span class="st">"Roboto"</span>,</span>
<span></span>
<span>  <span class="co"># ggplot image size and position</span></span>
<span>  s_x<span class="op">=</span><span class="fl">1.02</span>, s_y<span class="op">=</span><span class="fl">1.19</span>, s_width<span class="op">=</span><span class="fl">2.6</span>, s_height<span class="op">=</span><span class="fl">2.72</span>,</span>
<span></span>
<span>  <span class="co"># white hex</span></span>
<span>  h_fill<span class="op">=</span><span class="st">"#ffffff"</span>, h_color<span class="op">=</span><span class="st">"grey"</span>, h_size<span class="op">=</span><span class="fl">1.3</span>,</span>
<span></span>
<span>  <span class="co"># url</span></span>
<span>  url <span class="op">=</span> <span class="st">"github.com/rOpenSpain/spanishoddata"</span>,</span>
<span>  u_color<span class="op">=</span> <span class="st">"gray25"</span>,</span>
<span>  u_family <span class="op">=</span> <span class="st">"Roboto"</span>,</span>
<span>  u_size <span class="op">=</span> <span class="fl">1.2</span>,</span>
<span></span>
<span>  <span class="co"># save output name and resolution</span></span>
<span>  filename<span class="op">=</span><span class="st">"./man/figures/logo.png"</span>, dpi<span class="op">=</span><span class="fl">300</span> <span class="co">#</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<p><img src="../reference/figures/logo.png"></p>
<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-R-mapspain" class="csl-entry" role="listitem">
Hernangómez, Diego. 2024. <em><span class="nocase">mapSpain</span>: Administrative Boundaries of Spain</em> (version 0.9.2). <a href="https://doi.org/10.5281/zenodo.5366622" class="external-link">https://doi.org/10.5281/zenodo.5366622</a>.
</div>
<div id="ref-flowmapper-r" class="csl-entry" role="listitem">
Mast, Johannes. 2024. <em>Flowmapper: Draw Flows (Migration, Goods, Money, Information) on ’Ggplot2’ Plots</em>. <a href="https://doi.org/10.32614/CRAN.package.flowmapper" class="external-link">https://doi.org/10.32614/CRAN.package.flowmapper</a>.
</div>
<div id="ref-hexSticker-r" class="csl-entry" role="listitem">
Yu, Guangchuang. 2020. <em>hexSticker: Create Hexagon Sticker in r</em>. <a href="https://doi.org/10.32614/CRAN.package.hexSticker" class="external-link">https://doi.org/10.32614/CRAN.package.hexSticker</a>.
</div>
</div>
</section></section><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'light-border',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config);
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script></main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>


   </div>

  <!-- ropenspain rostemplate -->
<footer id="footer"><div class="container">
    <div class="row">
      <div class="col-md">
        <h4 data-toc-skip>About <img src="../logo.png" alt="spanishoddata Logo" height="24"> spanishoddata</h4>
        <p>Developed by <a href="https://www.ekotov.pro" class="external-link">Egor Kotov</a>, <a href="https://www.robinlovelace.net/" class="external-link">Robin Lovelace</a>.</p>
        <p>Part of the <span class="ROS-light">rOpenSpain</span> project.</p>
        <hr class="d-md-none">
</div>
      <div class="col-md offset-md-4">
        <h4 data-toc-skip>About <img src="../ROS-logo.png" alt="ROpenSpain Logo" height="24"><span class="ROS-light"> rOpenSpain</span>
</h4>
        <a href="https://ropenspain.es/" class="external-link"><span class="ROS-light">rOpenSpain</span></a> is a community of R enthusiasts whose ultimate goal is to create high-quality R packages for data mining public Spanish open sources.
        <hr class="d-md-none">
</div>
   </div>
  </div>
</footer><div id="copyright">
  <div class="container">
    <div class="row">
      <div class="col-md text-center text-lg-start">
        <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
      </div>
      <div class="col-md offset-md-4 text-center text-lg-start">
      <p>Template <a href="https://github.com/ropenspain/rostemplate/" class="external-link">rostemplate</a> by <a href="https://github.com/dieghernan/" class="external-link">dieghernan</a>, based on <a href="https://bootstrapious.com/" class="external-link">Bootstrapious</a>.
      </p>
      </div>
    </div>
  </div>
</div>




  <script>
var h1s = document.getElementsByTagName("h1");
var myH1;
if (h1s.length > 0) {
  myH1 = h1s[0];
  myH1.classList.add("ROSh1");
}
</script>
</body>
</html>
