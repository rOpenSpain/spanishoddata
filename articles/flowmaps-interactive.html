<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Making interactive flow maps • spanishoddata</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><script src="flowmaps-interactive_files/libs/quarto-html/popper.min.js"></script><script src="flowmaps-interactive_files/libs/quarto-html/tippy.umd.min.js"></script><link href="flowmaps-interactive_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="flowmaps-interactive_files/libs/quarto-html/light-border.css" rel="stylesheet">
<!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Making interactive flow maps">
<meta property="og:image" content="https://rOpenSpain.github.io/spanishoddata/reference/figures/card.png">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:creator" content="@rOpenSpain">
<meta name="twitter:site" content="@rOpenSpain">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&amp;family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&amp;display=swap" rel="stylesheet">
<!-- rogtemplate style sheet --><link href="../BS5/rostemplate.min.css" rel="stylesheet">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
  <a class="navbar-brand me-2" href="../index.html">
    <img src="../apple-touch-icon-180x180.png" alt="spanishoddata logo" height="40" class="d-inline-block me-1">spanishoddata</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.1</small>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/v1-2020-2021-mitma-data-codebook.html">Codebook and cookbook for v1 (2020-2021) Spanish mobility data</a></li>
    <li><a class="dropdown-item" href="../articles/v2-2022-onwards-mitma-data-codebook.html">Codebook and cookbook for v2 (2022 onwards) Spanish mobility data</a></li>
    <li><a class="dropdown-item" href="../articles/convert.html">Download and convert mobility datasets</a></li>
    <li><a class="dropdown-item" href="../articles/uses.html">Use cases</a></li>
    <li><a class="dropdown-item" href="../articles/flowmaps-static.html">Making static flow maps</a></li>
    <li><a class="dropdown-item" href="../articles/flowmaps-interactive.html">Making interactive flow maps</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/rOpenSpain/spanishoddata/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>
  </div>
</nav><div class="container template-quarto">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Making interactive flow maps</h1>




      <small class="dont-index">Source: <a href="https://github.com/rOpenSpain/spanishoddata/blob/85-error-if-cache-folder-not-previously-created/vignettes/flowmaps-interactive.qmd" class="external-link"><code>vignettes/flowmaps-interactive.qmd</code></a></small>
      <div class="d-none name"><code></code></div>
    </div>






    <p>This tutorial shows how to make interactive ‘flow maps’ with data from <a href="https://rOpenSpain.github.io/spanishoddata/">spanishoddata</a> and the <a href="https://github.com/FlowmapBlue/flowmapblue.R" class="external-link">flowmapblue</a> <span class="citation" data-cites="flowmapblue_r">(<a href="#ref-flowmapblue_r" role="doc-biblioref">Boyandin 2024</a>)</span> data visualisation package. We cover two examples. <a href="#simple-example">First</a>, we only visualise the total flows for a single day. In the <a href="#advanced-example">second</a> more advanced example we also use the time component that allows you to interactively filter flows by time of day. For both examples, make sure you first go though the initial <a href="#setup">setup steps</a>. To make static flow maps, please see the <a href="https://ropenspain.github.io/spanishoddata/articles/flowmaps-static.html" class="external-link">static flow maps</a> tutorial.</p>
<section class="section level2" data-number="1"><h2 data-number="1" id="setup">
<span class="header-section-number">1</span> Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h2>
<p>For the basemap in the final visualisation you will need a free Mapbox access token. You can get one at <a href="https://account.mapbox.com/access-tokens/" target="_blank" class="external-link">account.mapbox.com/access-tokens/</a> (you need to have a Mapbox account, which is free). You may skip this step, but in this case your interative flowmap will have no basemap, and the flows will just flow on solid colour background.</p>
<p>Once you got the access token, you can set it in the <code>MAPBOX_TOKEN</code> environment variable like so:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Sys.setenv.html" class="external-link">Sys.setenv</a></span><span class="op">(</span>MAPBOX_TOKEN <span class="op">=</span> <span class="st">"YOUR_MAPBOX_ACCESS_TOKEN"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rOpenSpain.github.io/spanishoddata/">spanishoddata</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/FlowmapBlue/flowmapblue.R" class="external-link">flowmapblue</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span></code></pre></div>
</div>
<section class="level2" data-number="1.1"><h3 data-number="1.1" id="set-data-folder">
<span class="header-section-number">1.1</span> Set the data directory<a class="anchor" aria-label="anchor" href="#set-data-folder"></a>
</h3>
<p>Choose where <a href="https://rOpenSpain.github.io/spanishoddata/">spanishoddata</a> should download (and convert) the data by setting the <code>SPANISH_OD_DATA_DIR</code> environment variable with the following command:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Sys.setenv.html" class="external-link">Sys.setenv</a></span><span class="op">(</span>SPANISH_OD_DATA_DIR <span class="op">=</span> <span class="st">"~/spanish_od_data"</span><span class="op">)</span></span></code></pre></div>
</div>
<p>The package will create this directory if it does not exist on the first run of any function that downloads the data.</p>
<details><summary>
Setting data directory for advanced users
</summary><p>To permanently set the directory for all projects, you can specify the data directory globally by setting the <code>SPANISH_OD_DATA_DIR</code> environment variable, e.g. with the following command:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">usethis</span><span class="fu">::</span><span class="fu"><a href="https://usethis.r-lib.org/reference/edit.html" class="external-link">edit_r_environ</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># Then set the data directory globally, by typing this line in the file:</span></span></code></pre></div>
</div>
<pre><code><span><span class="va">SPANISH_OD_DATA_DIR</span> <span class="op">=</span> <span class="st">"~/spanish_od_data"</span></span></code></pre>
<p>You can also set the data directory locally, just for the current project. Set the ‘envar’ in the working directory by editing <code>.Renviron</code> file in the root of the project:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/file.edit.html" class="external-link">file.edit</a></span><span class="op">(</span><span class="st">".Renviron"</span><span class="op">)</span></span></code></pre></div>
</div>
</details></section></section><section class="section level2" data-number="2"><h2 data-number="2" id="simple-example">
<span class="header-section-number">2</span> Simple example - plot flows data as it is<a class="anchor" aria-label="anchor" href="#simple-example"></a>
</h2>
<section class="level2" data-number="2.1"><h3 data-number="2.1" id="get-data">
<span class="header-section-number">2.1</span> Get data<a class="anchor" aria-label="anchor" href="#get-data"></a>
</h3>
<section class="level3" data-number="2.1.1"><h4 data-number="2.1.1" id="flows">
<span class="header-section-number">2.1.1</span> Flows<a class="anchor" aria-label="anchor" href="#flows"></a>
</h4>
<p>Let us get the flows between <code>districts</code> for a tipycal working day <code>2021-04-07</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">od_20210407</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spod_get.html">spod_get</a></span><span class="op">(</span><span class="st">"od"</span>, zones <span class="op">=</span> <span class="st">"distr"</span>, dates <span class="op">=</span> <span class="st">"2021-04-07"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">od_20210407</span><span class="op">)</span></span></code></pre></div>
</div>
<pre><code># Source:   SQL [6 x 14]
# Database: DuckDB v1.0.0 [root@Darwin 23.6.0:R 4.4.1/:memory:]
  date       id_origin id_destination activity_origin activity_destination residence_province_ine_code residence_province_name time_slot distance n_trips trips_total_length_km  year month   day
  &lt;date&gt;     &lt;fct&gt;     &lt;fct&gt;          &lt;fct&gt;           &lt;fct&gt;                &lt;fct&gt;                       &lt;fct&gt;                       &lt;int&gt; &lt;fct&gt;      &lt;dbl&gt;                 &lt;dbl&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;
1 2021-04-07 01001_AM  01001_AM       home            other                01                          Araba/Álava                     0 005-010     10.5                  68.9  2021     4     7
2 2021-04-07 01001_AM  01001_AM       home            other                01                          Araba/Álava                     0 010-050     12.6                 127.   2021     4     7
3 2021-04-07 01001_AM  01001_AM       home            other                01                          Araba/Álava                     1 010-050     12.6                 232.   2021     4     7
4 2021-04-07 01001_AM  01001_AM       home            other                01                          Araba/Álava                     2 005-010     10.8                 102.   2021     4     7
5 2021-04-07 01001_AM  01001_AM       home            other                01                          Araba/Álava                     5 005-010     18.9                 156.   2021     4     7
6 2021-04-07 01001_AM  01001_AM       home            other                01                          Araba/Álava                     6 010-050     10.8                 119.   2021     4     7</code></pre>
</section><section class="level3" data-number="2.1.2"><h4 data-number="2.1.2" id="zones">
<span class="header-section-number">2.1.2</span> Zones<a class="anchor" aria-label="anchor" href="#zones"></a>
</h4>
<p>We also get the district zones polygons to mathch the flows. We use version 1 for the polygons, because the selected date is in 2021, which corresponds to the v1 data (see the relevant <a href="v1-2020-2021-mitma-data-codebook.qmd">codebook</a>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">districts_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spod_get_zones.html">spod_get_zones</a></span><span class="op">(</span><span class="st">"dist"</span>, ver <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">districts_v1</span><span class="op">)</span></span></code></pre></div>
</div>
<pre><code>Simple feature collection with 6 features and 6 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: 289502.8 ymin: 4173922 xmax: 1010926 ymax: 4720817
Projected CRS: ETRS89 / UTM zone 30N (N-E)
# A tibble: 6 × 7
  id       census_districts                                              municipalities_mitma municipalities                                                                                  district_names_in_v2 district_ids_in_v2                      geom
  &lt;chr&gt;    &lt;chr&gt;                                                         &lt;chr&gt;                &lt;chr&gt;                                                                                           &lt;chr&gt;                &lt;chr&gt;                     &lt;MULTIPOLYGON [m]&gt;
1 2408910  2408910                                                       24089                24089                                                                                           León distrito 10     2408910            (((290940.1 4719080, 290…
2 22117_AM 2210201; 2210301; 2211501; 2211701; 2216401; 2218701; 2221401 22117_AM             22102; 22103; 22115; 22117; 22164; 22187; 22214; 22102; 22103; 22115; 22117; 22164; 22187; 222… Graus agregacion de… 22117_AM           (((774184.4 4662153, 774…
3 2305009  2305009                                                       23050                23050                                                                                           Jaén distrito 09     2305009            (((429745 4179977, 42971…
4 07058_AM 0701901; 0702501; 0703401; 0705801; 0705802                   07058_AM             07019; 07025; 07034; 07058; 07019; 07025; 07034; 07058; 07019; 07025; 07034; 07058; 07019; 070… Selva agregacion de… 07058_AM           (((1000859 4415059, 1000…
5 2305006  2305006                                                       23050                23050                                                                                           Jaén distrito 06     2305006            (((429795.1 4180957, 429…
6 2305005  2305005                                                       23050                23050                                                                                           Jaén distrito 05     2305005            (((430022.7 4181101, 429…</code></pre>
</section></section><section class="level2" data-number="2.2"><h3 data-number="2.2" id="prepare-data-for-visualization">
<span class="header-section-number">2.2</span> Prepare data for visualization<a class="anchor" aria-label="anchor" href="#prepare-data-for-visualization"></a>
</h3>
<section class="level3" data-number="2.2.1"><h4 data-number="2.2.1" id="expected-data-format">
<span class="header-section-number">2.2.1</span> Expected data format<a class="anchor" aria-label="anchor" href="#expected-data-format"></a>
</h4>
<p>To visualise the flows, <a href="https://github.com/FlowmapBlue/flowmapblue.R" class="external-link">flowmapblue</a> expects two <code>data.frame</code>s in the following format (we use the packages’s built-in data on Switzerland for illustration):</p>
<p><strong>Locations</strong></p>
<p>A <code>data.frame</code> with <code>id</code>, optional <code>name</code>, as well as <code>lat</code> and <code>lon</code> for coordinates of the locations in WGS84 (EPSG: 4326) coordinate reference system.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="fu">flowmapblue</span><span class="fu">::</span><span class="va"><a href="https://flowmapblue.github.io/flowmapblue.R/reference/ch_locations.html" class="external-link">ch_locations</a></span><span class="op">)</span></span></code></pre></div>
</div>
<pre><code>'data.frame':   26 obs. of  4 variables:
 $ id  : chr  "ZH" "LU" "UR" "SZ" ...
 $ name: chr  "Zürich" "Luzern" "Uri" "Schwyz" ...
 $ lat : num  47.4 47.1 46.8 47.1 46.9 ...
 $ lon : num  8.65 8.11 8.63 8.76 8.24 ...</code></pre>
<p><strong>Flows</strong></p>
<p>A <code>data.frame</code> with <code>origin</code>, <code>dest</code>, and <code>count</code> for the flows between locations, where <code>origin</code> and <code>dest</code> must match with <code>id</code>’s of the locations <code>data.frame</code> from above, and <code>count</code> is the number of trips between them.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="fu">flowmapblue</span><span class="fu">::</span><span class="va"><a href="https://flowmapblue.github.io/flowmapblue.R/reference/ch_flows.html" class="external-link">ch_flows</a></span><span class="op">)</span></span></code></pre></div>
</div>
<pre><code>str(flowmapblue::ch_flows)
'data.frame':   676 obs. of  3 variables:
 $ origin: chr  "ZH" "ZH" "ZH" "ZH" ...
 $ dest  : chr  "ZH" "BE" "LU" "UR" ...
 $ count : int  66855 1673 1017 84 1704 70 94 250 1246 173 ...</code></pre>
</section><section class="level3" data-number="2.2.2"><h4 data-number="2.2.2" id="aggregate-data---count-total-flows">
<span class="header-section-number">2.2.2</span> Aggregate data - count total flows<a class="anchor" aria-label="anchor" href="#aggregate-data---count-total-flows"></a>
</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">od_20210407_total</span> <span class="op">&lt;-</span> <span class="va">od_20210407</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span>origin <span class="op">=</span> <span class="va">id_origin</span>, dest <span class="op">=</span> <span class="va">id_destination</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">summarise</span><span class="op">(</span>count <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">n_trips</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">collect</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">od_20210407_total</span><span class="op">)</span></span></code></pre></div>
</div>
<pre><code># A tibble: 6 × 3
  origin   dest       count
  &lt;fct&gt;    &lt;fct&gt;      &lt;dbl&gt;
1 01001_AM 01036      39.8
2 01001_AM 01051    2508.
3 01001_AM 0105903  1644.
4 01001_AM 09363_AM    3.96
5 01001_AM 09907_AM   32.6
6 01001_AM 17033       9.61</code></pre>
</section></section><section class="level2" data-number="2.3"><h3 data-number="2.3" id="create-locations-table">
<span class="header-section-number">2.3</span> Create locations table with coordinates<a class="anchor" aria-label="anchor" href="#create-locations-table"></a>
</h3>
<p>We need the coordinates for each origin and destination. We can use the centroids of <code>districts_v1</code> polygons for that.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">districts_v1_centroids</span> <span class="op">&lt;-</span> <span class="va">districts_v1</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="fl">4326</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_centroid</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html" class="external-link">st_coordinates</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>id <span class="op">=</span> <span class="va">districts_v1</span><span class="op">$</span><span class="va">id</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">rename</span><span class="op">(</span>lon <span class="op">=</span> <span class="va">X</span>, lat <span class="op">=</span> <span class="va">Y</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">districts_v1_centroids</span><span class="op">)</span></span></code></pre></div>
</div>
<pre><code>         lon      lat       id
1 -5.5551053 42.59849  2408910
2  0.3260681 42.17266 22117_AM
3 -3.8136448 37.74344  2305009
4  2.8542636 39.80672 07058_AM
5 -3.8229513 37.77294  2305006
6 -3.8151096 37.86309  2305005</code></pre>
</section><section class="level2" data-number="2.4"><h3 data-number="2.4" id="create-the-plot">
<span class="header-section-number">2.4</span> Create the plot<a class="anchor" aria-label="anchor" href="#create-the-plot"></a>
</h3>
<p>Remember, what for the map to have a basemap, you need to have setup your Mapbox access token in the <a href="#setup">setup</a> section of this vignette.</p>
<p>Create the interactive flowmap with the <code>flowmapblue</code> function. In the example below we use the <code>darkMode</code> and <code>clustering</code>, and we disable the <code>animation</code>. We do not recommend disabling the <code>clustering</code> when plotting the flows between hundreds and thousands of locations, as this will reduce the redability of the map.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">flowmap</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://flowmapblue.github.io/flowmapblue.R/reference/flowmapblue.html" class="external-link">flowmapblue</a></span><span class="op">(</span></span>
<span>  locations <span class="op">=</span> <span class="va">districts_v1_centroids</span>,</span>
<span>  flows <span class="op">=</span> <span class="va">od_20210407_total</span>,</span>
<span>  mapboxAccessToken <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"MAPBOX_TOKEN"</span><span class="op">)</span>,</span>
<span>  darkMode <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  animation <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  clustering <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">flowmap</span></span></code></pre></div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure><p><video src="https://ropenspain.github.io/spanishoddata/media/flowmapblue-standard.mp4" style="width:80.0%" controls=""><a href="https://ropenspain.github.io/spanishoddata/media/flowmapblue-standard.mp4" class="external-link">Video</a></video></p>
<figcaption>Video demonstrating the standard interactive flowmap</figcaption></figure>
</div>
<p><img src="../reference/figures/flowmapblue-standard-01.png" style="width:45.0%" alt="Screenshot demonstrating the standard interactive flowmap"><img src="../reference/figures/flowmapblue-standard-02.png" style="width:45.0%" alt="Screenshot demonstrating the standard interactive flowmap"></p>
<p>You can play around with the arguments of the <code>flowmapblue</code> function. For example, you can turn on the <code>animation</code> mode:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">flowmap_anim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://flowmapblue.github.io/flowmapblue.R/reference/flowmapblue.html" class="external-link">flowmapblue</a></span><span class="op">(</span></span>
<span>  locations <span class="op">=</span> <span class="va">districts_v1_centroids</span>,</span>
<span>  flows <span class="op">=</span> <span class="va">od_20210407_total</span>,</span>
<span>  mapboxAccessToken <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"MAPBOX_TOKEN"</span><span class="op">)</span>,</span>
<span>  darkMode <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  animation <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  clustering <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">flowmap_anim</span></span></code></pre></div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure><p><video src="https://ropenspain.github.io/spanishoddata/media/flowmapblue-animated.mp4" style="width:80.0%" controls=""><a href="https://ropenspain.github.io/spanishoddata/media/flowmapblue-animated.mp4" class="external-link">Video</a></video></p>
<figcaption>Video demonstrating the animated interactive flowmap</figcaption></figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="../reference/figures/flowmapblue-animated.png" style="width:80.0%"></p>
<figcaption>Screenshot demonstrating the animated interactive flowmap</figcaption></figure>
</div>
</section></section><section class="section level2" data-number="3"><h2 data-number="3" id="advanced-example">
<span class="header-section-number">3</span> Advanced example - time filter<a class="anchor" aria-label="anchor" href="#advanced-example"></a>
</h2>
<p>After following the simple example, let us now add a time filter to the flows. We will use the <code>flowmapblue</code> function to plot flows between <code>districts_v1_centroids</code> for a typical working day <code>2021-04-07</code>.</p>
<section class="level2" data-number="3.1"><h3 data-number="3.1" id="prepare-data-for-visualization-1">
<span class="header-section-number">3.1</span> Prepare data for visualization<a class="anchor" aria-label="anchor" href="#prepare-data-for-visualization-1"></a>
</h3>
<p>Just like before, we aggregate the data and rename some columns. This time we will keep combine the <code>date</code> and <code>time_slot</code> (which corresponds to the hour of the day) to procude timestamps, so that the flows can be interactively filtered by time of day.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">od_20210407_time</span> <span class="op">&lt;-</span> <span class="va">od_20210407</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html" class="external-link">as.POSIXct</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">date</span>, <span class="st">"T"</span>, <span class="va">time_slot</span>, <span class="st">":00:00"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span>origin <span class="op">=</span> <span class="va">id_origin</span>, dest <span class="op">=</span> <span class="va">id_destination</span>, <span class="va">time</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">summarise</span><span class="op">(</span>count <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">n_trips</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">collect</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">od_20210407_time</span><span class="op">)</span></span></code></pre></div>
</div>
<pre><code># A tibble: 6 × 4
  origin dest    time                count
  &lt;fct&gt;  &lt;fct&gt;   &lt;dttm&gt;              &lt;dbl&gt;
1 08054  0818401 2021-04-07 01:00:00 43.7
2 08054  0818401 2021-04-07 17:00:00 87.1
3 08054  0818402 2021-04-07 16:00:00 62.6
4 08054  0818403 2021-04-07 05:00:00 26.8
5 08054  0818403 2021-04-07 07:00:00 44.9
6 08054  0818403 2021-04-07 02:00:00  7.11</code></pre>
<section class="level4" data-number="3.1.0.1"><h5 data-number="3.1.0.1" id="filter-the-zones">
<span class="header-section-number">3.1.0.1</span> Filter the zones<a class="anchor" aria-label="anchor" href="#filter-the-zones"></a>
</h5>
<p>Because we are now using the flows for each hour of the day, there are 24 times more rows in this data, than in the simple example. Therefore it will take longer to generate the plot and the resulting visualisation may work slower. To create a more manageable example, let us only filter the data to Madrid and surrounding areas.</p>
<p>Let us select all districts that correspond to Barcelona and a 10 km radius around it. Thanks to the <code>district_names_in_v2</code> column in the zones data, we can easily select all the districts that correspond to Barcelona and then apply the spatial join on the to select some more districts around the polygons that correspond to Barcelona.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">zones_barcelona</span> <span class="op">&lt;-</span> <span class="va">districts_v1</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"Barcelona"</span>, <span class="va">district_names_in_v2</span>, ignore.case <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">zones_barcelona_fua</span> <span class="op">&lt;-</span> <span class="va">districts_v1</span><span class="op">[</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_buffer</a></span><span class="op">(</span><span class="va">zones_barcelona</span>, dist <span class="op">=</span> <span class="fl">10000</span><span class="op">)</span></span>
<span>  ,</span>
<span><span class="op">]</span></span>
<span></span>
<span><span class="va">zones_barcelona_fua_plot</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">zones_barcelona_fua</span>, fill<span class="op">=</span><span class="cn">NA</span>, col <span class="op">=</span> <span class="st">"grey60"</span>, linewidth <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">zones_barcelona_fua_plot</span></span></code></pre></div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="../reference/figures/zones_barcelona_fua_plot.png" style="width:80.0%"></p>
<figcaption>District zone boundaries in Barcelona and nearby areas</figcaption></figure>
</div>
<p>Now we prepare the table with coordinates for the flowmap:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">zones_barcelona_fua_coords</span> <span class="op">&lt;-</span> <span class="va">zones_barcelona_fua</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span>crs <span class="op">=</span> <span class="fl">4326</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_centroid</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html" class="external-link">st_coordinates</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>id <span class="op">=</span> <span class="va">zones_barcelona_fua</span><span class="op">$</span><span class="va">id</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">rename</span><span class="op">(</span>lon <span class="op">=</span> <span class="va">X</span>, lat <span class="op">=</span> <span class="va">Y</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">zones_barcelona_fua_coords</span><span class="op">)</span></span></code></pre></div>
</div>
<pre><code>       lon      lat      id
1 2.154317 41.49969   08180
2 1.968438 41.48274   08054
3 2.106401 41.41265 0801905
4 2.118221 41.38697 0801904
5 2.150536 41.42915 0801907
6 2.152419 41.41014 0801906</code></pre>
</section><section class="level4" data-number="3.1.0.2"><h5 data-number="3.1.0.2" id="prepare-the-flows">
<span class="header-section-number">3.1.0.2</span> Prepare the flows<a class="anchor" aria-label="anchor" href="#prepare-the-flows"></a>
</h5>
<p>Now we can use the zone <code>id</code>s from the <code>zones_barcelona_fua</code> data to select the flows that correspond to Barcelona and the 10 km radius around it.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">od_20210407_time_barcelona</span> <span class="op">&lt;-</span> <span class="va">od_20210407_time</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">origin</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">zones_barcelona_fua</span><span class="op">$</span><span class="va">id</span> <span class="op">&amp;</span> <span class="va">dest</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">zones_barcelona_fua</span><span class="op">$</span><span class="va">id</span><span class="op">)</span></span></code></pre></div>
</div>
</section><section class="level4" data-number="3.1.0.3"><h5 data-number="3.1.0.3" id="visualise-the-flows-for-barcelona-and-surrounding-areas">
<span class="header-section-number">3.1.0.3</span> Visualise the flows for Barcelona and surrounding areas<a class="anchor" aria-label="anchor" href="#visualise-the-flows-for-barcelona-and-surrounding-areas"></a>
</h5>
<p>Now, we can create a new plot with this data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">flowmap_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://flowmapblue.github.io/flowmapblue.R/reference/flowmapblue.html" class="external-link">flowmapblue</a></span><span class="op">(</span></span>
<span>  locations <span class="op">=</span> <span class="va">zones_barcelona_fua_coords</span>,</span>
<span>  flows <span class="op">=</span> <span class="va">od_20210407_time_barcelona</span>,</span>
<span>  mapboxAccessToken <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"MAPBOX_TOKEN"</span><span class="op">)</span>,</span>
<span>  darkMode <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  animation <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  clustering <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">flowmap_time</span></span></code></pre></div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure><p><video src="https://rOpenSpain.github.io/spanishoddata/media/flowmapblue-standard-time.mp4" style="width:80.0%" controls=""><a href="https://rOpenSpain.github.io/spanishoddata/media/flowmapblue-standard-time.mp4">Video</a></video></p>
<figcaption>Video demonstrating the time filtering on a flowmap</figcaption></figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="../reference/figures/flowmapblue-standard-time.png" style="width:80.0%"></p>
<figcaption>Screnshot demonstrating the time filtering on a flowmap</figcaption></figure>
</div>
<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-flowmapblue_r" class="csl-entry" role="listitem">
Boyandin, Ilya. 2024. <em>Flowmap.blue Widget for r</em>. <a href="https://doi.org/10.32614/CRAN.package.flowmapblue" class="external-link">https://doi.org/10.32614/CRAN.package.flowmapblue</a>.
</div>
</div>
</section></section></section><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'light-border',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config);
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script></main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>


   </div>

  <!-- ropenspain rostemplate -->
<footer id="footer"><div class="container">
    <div class="row">
      <div class="col-md">
        <h4 data-toc-skip>About <img src="../logo.png" alt="spanishoddata Logo" height="24"> spanishoddata</h4>
        <p>Developed by <a href="https://www.ekotov.pro" class="external-link">Egor Kotov</a>, <a href="https://www.robinlovelace.net/" class="external-link">Robin Lovelace</a>.</p>
        <p>Part of the <span class="ROS-light">rOpenSpain</span> project.</p>
        <hr class="d-md-none">
</div>
      <div class="col-md offset-md-4">
        <h4 data-toc-skip>About <img src="../ROS-logo.png" alt="ROpenSpain Logo" height="24"><span class="ROS-light"> rOpenSpain</span>
</h4>
        <a href="https://ropenspain.es/" class="external-link"><span class="ROS-light">rOpenSpain</span></a> is a community of R enthusiasts whose ultimate goal is to create high-quality R packages for data mining public Spanish open sources.
        <hr class="d-md-none">
</div>
   </div>
  </div>
</footer><div id="copyright">
  <div class="container">
    <div class="row">
      <div class="col-md text-center text-lg-start">
        <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
      </div>
      <div class="col-md offset-md-4 text-center text-lg-start">
      <p>Template <a href="https://github.com/ropenspain/rostemplate/" class="external-link">rostemplate</a> by <a href="https://github.com/dieghernan/" class="external-link">dieghernan</a>, based on <a href="https://bootstrapious.com/" class="external-link">Bootstrapious</a>.
      </p>
      </div>
    </div>
  </div>
</div>




  <script>
var h1s = document.getElementsByTagName("h1");
var myH1;
if (h1s.length > 0) {
  myH1 = h1s[0];
  myH1.classList.add("ROSh1");
}
</script>
</body>
</html>
